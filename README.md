# Backup Tool

## 仕様
- ディレクトリを指定して、バックアップを生成する
    - バックアップは、バックアップ元のディレクトリ以下にあるすべてのサブディレクトリ・ファイルをバックアップ先にコピーすることで行われる
    - バックアップディレクトリは複数指定できる

## 用語
- バックアップ日時
    - バックアップを開始した日時
    - 精度は年月日時分秒
    - 年は西暦
    - タイムゾーンはローカルを使用する

### バックアップの仕様

- オリジナルディレクトリ以下の、すべてのサブディレクトリに対して以下の処理を行う
    - 最も深いディレクトリから優先して実施する
    - バックアップ先にディレクトリがない場合（新規ディレクトリのバックアップ）
        - オリジナルのディレクトリを、サブディレクトリ・ファイルも含めてすべてバックアップ先にコピーする
    - バックアップ先にもディレクトリがある場合
        - ディレクトリ直下のファイルが、すべて完全に一致している場合
            - そのディレクトリ直下の処理はスキップする（サブディレクトリは、引き続き処理する）
        - ディレクトリ直下のファイルが、わずかでも一致していない場合
            - 各ファイルに対して以下の処理を行う
                - ファイルの内容が一致している場合
                    - 何もせず、そのファイルはスキップする
                - オリジナルにしかファイルが存在しない場合（新規ファイルのバックアップ）
                    - バックアップ先にファイルをコピーする
                - バックアップ先にしかファイルが存在しない場合（削除ファイルのバックアップ）
                    - バックアップ先のファイルを削除対象としてマークする
                - ファイルの内容が一致していない場合（修正ファイルのバックアップ）
                    - バックアップ先のファイルを過去世代としてマークする
                    - 最大保存世代より古い過去世代ファイルが存在する場合は、その過去世代ファイルを削除する
                    - オリジナルのファイルをバックアップ先にコピーする
- バックアップ先ディレクトリ以下の、すべてのサブディレクトリに対して以下の処理を行う
    - 最も**浅い**ディレクトリから優先して実施する
    - オリジナルにはディレクトリがない場合（削除ディレクトリのバックアップ）
        - バックアップ先のディレクトリ以下のすべてのファイルを、削除対象としてマークする
            - サブディレクトリ以下のファイルも、再帰的に削除対象としてマークしていく
        - バックアップ先のディレクトリ名は変更しない

#### ディレクトリ直下の完全一致比較方法
- ディレクトリ直下のファイル数が一致しない場合
    - 変化あり
- ディレクトリ直下のファイル数が一致している場合
    - 名前が一致していないファイルが１つでも存在する場合
        - 変化あり
    - すべてのファイル名が一致している場合
        - ディレクトリ直下の全ファイルを入力したハッシュ値（ディレクトリハッシュ）が、前回バックアップ時のものと異なる場合
            - 変化あり
        - ディレクトリハッシュが一致している場合
            - 変化なし

- ディレクトリハッシュの入力から除外するオブジェクト
    - ディレクトリ

#### ファイルの比較方法

- オリジナルファイルのハッシュ値を計算して、前回バックアップ時のものと比較する

#### メタディレクトリ・ファイル

- 過去世代ファイルやディレクトリハッシュを保存しておくディレクトリ・ファイル
- バックアップ先の各ディレクトリごとに `.$META$` という名前のディレクトリを作成する
    - このディレクトリを **メタディレクトリ** と呼ぶ
- メタディレクトリ内のファイルを **メタファイル** と呼ぶ
- メタファイルには、以下の種類が存在する
    - 過去世代ファイル
    - 削除対象ファイル
    - メタデータファイル

#### 過去世代ファイルの仕様

- 元のファイル名を `file_name.ext` とした場合、 `$OLD@yyyyMMdd_HHmmss$file_name.ext` という名前にリネームする
- `yyyyMMdd_HHmmss` の部分は、バックアップ日時を設定する

#### 削除対象ファイルの仕様

- 元のファイル名を `file_name.ext` とした場合、 `.$DEL@yyyyMMdd_HHmmss$file_name.ext` という名前にリネームする
- `yyyyMMdd_HHmmss` の部分は、バックアップ日時を設定する

#### メタデータファイルの仕様
- メタディレクトリ直下に `metadata.txt` という名前で作成する
- ファイルの仕様
    - テキストファイル
    - UTF-8 でエンコード
    - 改行コードは `\n`
- メタデータファイル内は、バックアップ直後のディレクトリ内の状態を入力に記載する
- 1行目にはディレクトリハッシュ値を記述する
- 2行目以降は、各ファイルの名前（拡張子含む）とファイルのハッシュ値を記録する
    - ファイル名とハッシュ値はタブ(`\t`)で区切る
    - ファイル名の順序に指定はない
- 空行はすべて無視する

```
<ディレクトリハッシュ値>
<ファイル名>\t<ファイルハッシュ値>
:
:
```

### クリーンアップの仕様

#### 共通仕様
- クリーンアップ処理は、ディレクトリの最も深いところから優先して実施する
- クリーンアップの結果、バックアップ先のディレクトリが以下の状態をすべて満たした場合は、そのバックアップ先ディレクトリを削除する
    - ディレクトリ内にファイルが存在しない
    - ディレクトリ内に、メタディレクトリ以外のサブディレクトリが存在しない
    - メタディレクトリ内に、以下のファイルが存在しない
        - 過去世代ファイル
        - 削除対象ファイル

#### 全クリーンアップ
- バックアップディレクトリ以下のすべてのサブディレクトリ・ファイルに対して、以下の処理を行う
    - 最大保存期間を過ぎている削除対象ファイルをすべて削除する
    - 名前が同じ過去世代ファイルが存在する場合は、それらも削除する

#### 日付指定クリーンアップ
- 日付は、以下のいずれかで指定できる
    - 年月日
    - 年月日＋時分秒
- バックアップディレクトリ以下のすべてのサブディレクトリ・ファイルに対して、以下の処理を行う
    - 削除日時が指定された条件に一致する削除対象ファイルをすべて削除する
        - 年月日のみ指定の場合
            - 年月日が一致する削除対象ファイルがすべて対象となる
        - 年月日＋時分秒指定の場合
            - 年月日＋時分秒がすべて一致する削除対象ファイルが対象となる
    - 過去世代ファイルが存在する場合は、それらも削除する

